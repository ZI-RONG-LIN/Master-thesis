data air1;set air;
kk=day||substr(_COL0,1,7);
run;
proc sort data=air1;by kk;run;

data m1;set m;
if  0101 <= code <= 0102 | 0109<= code <= 0112 | 0115 <= code <=0120 
then CT="臺北市"; 
if  1701 <= code <= 1708 | 3601 <= code <=3621 then CT="臺中市";
if  2101 <=code <=2107 | 4101 <= code <= 4131 then CT ="臺南市";
if  0201 <= code <= 0211| 4201 <=code<= 4227 then CT ="高雄市";
if  0301 <= code <= 0329 then CT="臺中市";
if  0501 <= code <= 0538 then CT ="臺南市";
if  0701 <= code <= 0738 then CT ="高雄市";
if  1101 <= code <= 1107 then CT = "基隆市";
if   code =1201|  code= 1204 |  code =1205 then CT="新竹市";
if  code =2201| code = 2202 then CT="嘉義市";
if 3101 <= code <= 3129 then CT = "新北市";
if 3201 <=code <= 3213 then CT = "桃園市";
if 3301 <= code<= 3314 then CT ="新竹縣" ;
if 3401 <=code <= 3412 then CT ="宜蘭縣";
if 3501 <=code<= 3518 then CT ="苗栗縣";
if 3701 <=code <= 3726 then CT = "彰化縣";
if 3801 <=code <= 3813 then CT="南投縣";
if 3901 <=code <= 3920 then CT = "雲林縣";
if 4001 <=code <=4018 then CT ="嘉義縣";
if 4301 <=code <= 4333 then CT ="屏東縣";
if 4501 <=code <= 4513 then CT = "花蓮縣";
if 4601 <=code <= 4616 then CT ="臺東縣";
if 9001 <=code<=9006 then CT="金門縣";
if 9101<=code<= 9104then CT="連江縣";
if 4401<=code<=4406 then CT="澎湖縣";
kk=date||CT;
run;
proc sort data=m1;by kk;run;


proc sort data=n1;by kk;run;

data m2;set m1;
by kk;
if first.kk then CT_count=0;
CT_count+count;
run;

data n1;set n;
if  0101 <= code <= 0102 | 0109<= code <= 0112 | 0115 <= code <=0120 
then CT="臺北市"; 
if  1701 <= code <= 1708 | 3601 <= code <=3621 then CT="臺中市";
if  2101 <=code <=2107 | 4101 <= code <= 4131 then CT ="臺南市";
if  0201 <= code <= 0211| 4201 <=code<= 4227 then CT ="高雄市";
if  0301 <= code <= 0329 then CT="臺中市";
if  0501 <= code <= 0538 then CT ="臺南市";
if  0701 <= code <= 0738 then CT ="高雄市";
if  1101 <= code <= 1107 then CT = "基隆市";
if   code =1201|  code= 1204 |  code =1205 then CT="新竹市";
if  code =2201| code = 2202 then CT="嘉義市";
if 3101 <= code <= 3129 then CT = "新北市";
if 3201 <=code <= 3213 then CT = "桃園市";
if 3301 <= code<= 3314 then CT ="新竹縣" ;
if 3401 <=code <= 3412 then CT ="宜蘭縣";
if 3501 <=code<= 3518 then CT ="苗栗縣";
if 3701 <=code <= 3726 then CT = "彰化縣";
if 3801 <=code <= 3813 then CT="南投縣";
if 3901 <=code <= 3920 then CT = "雲林縣";
if 4001 <=code <=4018 then CT ="嘉義縣";
if 4301 <=code <= 4333 then CT ="屏東縣";
if 4501 <=code <= 4513 then CT = "花蓮縣";
if 4601 <=code <= 4616 then CT ="臺東縣";
if 9001 <=code<=9006 then CT="金門縣";
if 9101<=code<= 9104then CT="連江縣";
if 4401<=code<=4406 then CT="澎湖縣";
kk=date||CT;
run;

data n2;set n1;
by kk;
if first.kk then CT_count=0;
CT_count+count;
run;

data n3;set n2;
by kk;
if last.kk;
keep date country CT kk CT_count code;
run;
data m3;set m2;
by kk;
if last.kk;
keep date country CT kk CT_count code;
run;

data code;set m2;
keep co kk code country;
rename country=_COL0;
run;
proc sort data=air1;by _col0;run;
proc sort data=code;by _col0;run;
data air2;
merge air1(IN=k) code;
by _col0;
if K=1;
run;

data air3;set air2;
if  0101 <= code <= 0102 | 0109<= code <= 0112 | 0115 <= code <=0120 
then CT="臺北市"; 
if  1701 <= code <= 1708 | 3601 <= code <=3621 then CT="臺中市";
if  2101 <=code <=2107 | 4101 <= code <= 4131 then CT ="臺南市";
if  0201 <= code <= 0211| 4201 <=code<= 4227 then CT ="高雄市";
if  0301 <= code <= 0329 then CT="臺中市";
if  0501 <= code <= 0538 then CT ="臺南市";
if  0701 <= code <= 0738 then CT ="高雄市";
if  1101 <= code <= 1107 then CT = "基隆市";
if   code =1201|  code= 1204 |  code =1205 then CT="新竹市";
if  code =2201| code = 2202 then CT="嘉義市";
if 3101 <= code <= 3129 then CT = "新北市";
if 3201 <=code <= 3213 then CT = "桃園市";
if 3301 <= code<= 3314 then CT ="新竹縣" ;
if 3401 <=code <= 3412 then CT ="宜蘭縣";
if 3501 <=code<= 3518 then CT ="苗栗縣";
if 3701 <=code <= 3726 then CT = "彰化縣";
if 3801 <=code <= 3813 then CT="南投縣";
if 3901 <=code <= 3920 then CT = "雲林縣";
if 4001 <=code <=4018 then CT ="嘉義縣";
if 4301 <=code <= 4333 then CT ="屏東縣";
if 4501 <=code <= 4513 then CT = "花蓮縣";
if 4601 <=code <= 4616 then CT ="臺東縣";
if 9001 <=code<=9006 then CT="金門縣";
if 9101<=code<= 9104then CT="連江縣";
if 4401<=code<=4406 then CT="澎湖縣";
kk=day||CT;
run;

data air30;set air3;
if lagtime =0;
run;

proc sort data=air30;by kk ;run;
data air40;set air30;
by kk;
if first.kk then count=0;
count+1;
run;
data air50;set air40;
by kk;
if first.kk then PM2_5=0;
PM2_5+r;
n_PM2_5=PM2_5/count;
run;
data air60;set air50;
by kk;
if first.kk then ozone=0;
ozone+O3;
n_O3=ozone/count;
run;
data air70;set air60;
by kk;
if first.kk then NO=0;
NO+NOx;
n_NOx=NO/count;
run;
data air80;set air70;
by kk;
if first.kk then SO=0;
SO+SOx;
n_SOx=SO/count;
run;
data air90;set air80;
by kk;
if first.kk then NM=0;
NM+NMHC;
n_NMHC=NM/count;
run;
data air100;set air90;
by kk;
if last.kk;
keep day lagtime kk CT n_PM2_5 n_O3 n_NOx n_SOx n_NMHC;
run;
proc sort data=m3;by kk;run;
proc sort data=air100;by kk;run;
data m4;
merge m3(IN=k) air100;
by kk;
if K=1;
run;

proc plot data=m4;
plot CT_count*n_NMHC;
symbol value= triangle color=red;
run;
proc corr data=m4;
with CT_count;
var n_NMHC; run;


data air32;set air3;
if lagtime =2;
run;

proc sort data=air32;by kk ;run;
data air42;set air32;
by kk;
if first.kk then count=0;
count+1;
run;
data air52;set air42;
by kk;
if first.kk then PM2_5=0;
PM2_5+r;
n_PM2_5=PM2_5/count;
run;
data air62;set air52;
by kk;
if first.kk then ozone=0;
ozone+O3;
n_O3=ozone/count;
run;
data air72;set air62;
by kk;
if first.kk then NO=0;
NO+NOx;
n_NOx=NO/count;
run;
data air82;set air72;
by kk;
if first.kk then SO=0;
SO+SOx;
n_SOx=SO/count;
run;
data air92;set air82;
by kk;
if first.kk then NM=0;
NM+NMHC;
n_NMHC=NM/count;
run;
data air102;set air92;
by kk;
if last.kk;
keep day lagtime kk CT n_PM2_5 n_O3 n_NOx n_SOx n_NMHC;
run;
proc sort data=m3;by kk;run;
proc sort data=air102;by kk;run;
data m42;
merge m3(IN=k) air102;
by kk;
if K=1;
run;

proc plot data=m42;
plot CT_count*n_O3;
symbol value= triangle color=red;
run;
proc corr data=m4;
with CT_count;
var n_O3; run;
